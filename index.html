<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>5Dice Kniffel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url('https://images.unsplash.com/photo-1512427691650-2e4f7b0bc123?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
    background-size: cover;
    margin: 0; padding: 0;
  }
  .container {
    background: rgba(255,255,255,0.9);
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 10px;
  }
  h1 {
    text-align: center;
  }
  #dice-container {
    text-align: center;
    margin-bottom: 15px;
  }
  .dice {
    display: inline-block;
    width: 60px; height: 60px;
    margin: 0 5px;
    font-size: 32px;
    line-height: 60px;
    text-align: center;
    border: 2px solid #333;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
    background: #f0f0f0;
    position: relative;
  }
  .dice.held {
    background: #a3d2ca;
    border-color: #388e3c;
  }
  button {
    margin: 10px auto;
    display: block;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #4caf50;
    color: white;
    user-select: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #999;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #4caf50;
    color: white;
  }
  td.selectable {
    cursor: pointer;
    background-color: #e0e0e0;
  }
  td.selectable:hover {
    background-color: #b2dfdb;
  }
  td.filled {
    background-color: #a3d2ca;
    cursor: default;
  }
  .score-header {
    font-weight: bold;
    background-color: #81c784;
  }
  .bonus, .gesamt {
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="container">
  <h1>5Dice Kniffel</h1>
  <div id="dice-container">
    <!-- Würfel kommen hier rein -->
  </div>
  <button id="roll-button">Würfeln</button>
  <p id="roll-info">Würfe: 0 von 3</p>

  <table id="score-table">
    <thead>
      <tr>
        <th>Kategorie</th>
        <th>Eintrag</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>Einer</td><td class="selectable" data-category="1"></td></tr>
      <tr><td>Zweier</td><td class="selectable" data-category="2"></td></tr>
      <tr><td>Dreier</td><td class="selectable" data-category="3"></td></tr>
      <tr><td>Vierer</td><td class="selectable" data-category="4"></td></tr>
      <tr><td>Fünfer</td><td class="selectable" data-category="5"></td></tr>
      <tr><td>Sechser</td><td class="selectable" data-category="6"></td></tr>
      <tr class="score-header"><td>Bonus</td><td id="bonus">0</td></tr>
      <tr class="score-header"><td>Gesamt oben</td><td id="gesamt-ob"></td></tr>
      <tr><td>3er Pasch</td><td class="selectable" data-category="3p"></td></tr>
      <tr><td>4er Pasch</td><td class="selectable" data-category="4p"></td></tr>
      <tr><td>Full House</td><td class="selectable" data-category="fh"></td></tr>
      <tr><td>Kleine Straße</td><td class="selectable" data-category="ks"></td></tr>
      <tr><td>Große Straße</td><td class="selectable" data-category="gs"></td></tr>
      <tr><td>Kniffel</td><td class="selectable" data-category="kniffel"></td></tr>
      <tr><td>Chance</td><td class="selectable" data-category="chance"></td></tr>
      <tr class="score-header"><td>Gesamt unten</td><td id="gesamt-un"></td></tr>
      <tr class="score-header"><td>Gesamt</td><td id="gesamt"></td></tr>
    </tbody>
  </table>
</div>

<script>
  const diceContainer = document.getElementById('dice-container');
  const rollButton = document.getElementById('roll-button');
  const rollInfo = document.getElementById('roll-info');

  let dice = [1, 1, 1, 1, 1];
  let held = [false, false, false, false, false];
  let rolls = 0;
  let wertEingetragen = false; // Trackt, ob in aktueller Runde schon Wert eingetragen wurde

  // Würfel-Emojis (1 bis 6)
  const diceFaces = ["\u2680", "\u2681", "\u2682", "\u2683", "\u2684", "\u2685"];

  // Initiale Würfelanzeige
  function renderDice() {
    diceContainer.innerHTML = '';
    dice.forEach((value, idx) => {
      const die = document.createElement('div');
      die.classList.add('dice');
      if (held[idx]) die.classList.add('held');
      die.textContent = diceFaces[value - 1];
      die.addEventListener('click', () => {
        if (rolls === 0) return; // Noch nicht gewürfelt
        held[idx] = !held[idx];
        renderDice();
      });
      diceContainer.appendChild(die);
    });
  }

  // Würfeln
  function rollDice() {
    if (rolls >= 3) {
      alert('Du hast bereits 3-mal gewürfelt. Bitte trage einen Wert ein.');
      return;
    }
    for (let i = 0; i < 5; i++) {
      if (!held[i]) {
        dice[i] = Math.floor(Math.random() * 6) + 1;
      }
    }
    rolls++;
    wertEingetragen = false; // Neue Runde, Wert noch nicht eingetragen
    renderDice();
    updateRollInfo();
    activateSelectable();
  }

  // Anzeige der Würfe aktualisieren
  function updateRollInfo() {
    rollInfo.textContent = `Würfe: ${rolls} von 3`;
  }

  // Aktiviert anklickbare Felder in der Tabelle (nur, wenn noch kein Wert eingetragen)
  function activateSelectable() {
    const cells = document.querySelectorAll('td.selectable');
    cells.forEach(cell => {
      if (!wertEingetragen && !cell.classList.contains('filled')) {
        cell.style.pointerEvents = 'auto';
        cell.style.backgroundColor = '#e0e0e0';
        cell.addEventListener('click', onCategoryClick);
      } else {
        cell.style.pointerEvents = 'none';
        cell.style.backgroundColor = cell.classList.contains('filled') ? '#a3d2ca' : '#f0f0f0';
        cell.removeEventListener('click', onCategoryClick);
      }
    });
  }

  // Deaktiviert anklickbare Felder (nach Eintrag)
  function deactivateSelectable() {
    const cells = document.querySelectorAll('td.selectable');
    cells.forEach(cell => {
      cell.style.pointerEvents = 'none';
      cell.style.backgroundColor = cell.classList.contains('filled') ? '#a3d2ca' : '#f0f0f0';
      cell.removeEventListener('click', onCategoryClick);
    });
  }

  // Klick auf Kategorie in Tabelle
  function onCategoryClick(e) {
    if (wertEingetragen) {
      alert('Du kannst pro Runde nur einen Wert eintragen.');
      return;
    }
    const cell = e.currentTarget;
    const category = cell.getAttribute('data-category');
    if (cell.classList.contains('filled')) {
      alert('Kategorie ist schon eingetragen.');
      return;
    }
    const score = calculateScore(category);
    if (score === null) {
      alert('Kann diese Kategorie nicht berechnen.');
      return;
    }
    cell.textContent = score;
    cell.classList.add('filled');
    wertEingetragen = true;

    // Nach Eintragen Würfe zurücksetzen für nächste Runde
    rolls = 0;
    held = [false, false, false, false, false];
    dice = [1,1,1,1,1];
    renderDice();
    updateRollInfo();
    deactivateSelectable();
    updateBonusUndGesamt();
  }

  // Beispielhafte Score-Berechnung (passt du an deine Logik an)
  function calculateScore(category) {
    // Kategorie 1 bis 6: Summe der entsprechenden Würfel
    if ("123456".includes(category)) {
      const num = parseInt(category);
      return dice.filter(d => d === num).reduce((a,b) => a+b, 0);
    }
    // Für die anderen Kategorien nur Dummy-Beispiele:
    switch(category) {
      case '3p': // 3er Pasch
        if (hasNOfAKind(3)) return dice.reduce((a,b)=>a+b,0);
        return 0;
      case '4p': // 4er Pasch
        if (hasNOfAKind(4)) return dice.reduce((a,b)=>a+b,0);
        return 0;
      case 'fh': // Full House
        if (isFullHouse()) return 25;
        return 0;
      case 'ks': // Kleine Straße
        if (hasSmallStraight()) return 30;
        return 0;
      case 'gs': // Große Straße
        if (hasLargeStraight()) return 40;
        return 0;
      case 'kniffel':
        if (hasNOfAKind(5)) return 50;
        return 0;
      case 'chance':
        return dice.reduce((a,b)=>a+b,0);
      default:
        return null;
    }
  }

  // Hilfsfunktionen für Wertberechnung:
  function hasNOfAKind(n) {
    const counts = {};
    dice.forEach(d => counts[d] = (counts[d]||0)+1);
    return Object.values(counts).some(count => count >= n);
  }
  function isFullHouse() {
    const counts = {};
    dice.forEach(d => counts[d] = (counts[d]||0)+1);
    const values = Object.values(counts).sort();
    return values.length === 2 && values[0] === 2 && values[1] === 3;
  }
  function hasSmallStraight() {
    const unique = [...new Set(dice)].sort();
    const straights = [
      [1,2,3,4],
      [2,3,4,5],
      [3,4,5,6]
    ];
    return straights.some(straight => straight.every(num => unique.includes(num)));
  }
  function hasLargeStraight() {
    const unique = [...new Set(dice)].sort();
    const straights = [
      [1,2,3,4,5],
      [2,3,4,5,6]
    ];
    return straights.some(straight => straight.every(num => unique.includes(num)));
  }

  // Bonus und Gesamtsummen berechnen
  function updateBonusUndGesamt() {
    // Oben Summe (Einer bis Sechser)
    let sumOben = 0;
    for(let i=1; i<=6; i++) {
      const cell = document.querySelector(`td.selectable[data-category="${i}"]`);
      if(cell && cell.classList.contains('filled')) {
        sumOben += parseInt(cell.textContent) || 0;
      }
    }
    document.getElementById('bonus').textContent = sumOben >= 63 ? 35 : 0;
    document.getElementById('gesamt-ob').textContent = sumOben + (sumOben >= 63 ? 35 : 0);

    // Unten Summe (3er Pasch bis Chance)
    const untenCats = ['3p','4p','fh','ks','gs','kniffel','chance'];
    let sumUnten = 0;
    untenCats.forEach(cat => {
      const cell = document.querySelector(`td.selectable[data-category="${cat}"]`);
      if(cell && cell.classList.contains('filled')) {
        sumUnten += parseInt(cell.textContent) || 0;
      }
    });
    document.getElementById('gesamt-un').textContent = sumUnten;

    // Gesamt Summe
    document.getElementById('gesamt').textContent = sumOben + (sumOben >= 63 ? 35 : 0) + sumUnten;
  }

  // Setup initial
  rollButton.addEventListener('click', rollDice);
  renderDice();
  updateRollInfo();
  deactivateSelectable();

</script>
</body>
</html>
